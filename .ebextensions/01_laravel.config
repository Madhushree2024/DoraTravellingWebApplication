option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /public
    memory_limit: 256M

container_commands:
  01_create_sqlite_database:
    command: |
      mkdir -p /var/app/staging/database
      touch /var/app/staging/database/database.sqlite
      chmod 775 /var/app/staging/database/database.sqlite
      chown webapp:webapp /var/app/staging/database/database.sqlite
      
  02_set_permissions:
    command: |
      chmod -R 775 /var/app/staging/storage
      chown -R webapp:webapp /var/app/staging/storage
      chmod -R 775 /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/bootstrap/cache
      
  03_copy_environment:
    command: |
      cp /var/app/staging/.env.production /var/app/staging/.env
      chmod 644 /var/app/staging/.env
      
  04_migrate_and_setup:
    command: |
      cd /var/app/staging
      php artisan migrate --force
      php artisan key:generate --force
      php artisan config:clear
      php artisan cache:clear
      php artisan storage:link
      
  05_ensure_storage_directories:
    command: |
      # Create image directories in staging
      mkdir -p /var/app/staging/storage/app/public/images
      mkdir -p /var/app/staging/storage/app/public/properties
      
      # Ensure correct permissions
      chmod -R 775 /var/app/staging/storage/app/public
      chown -R webapp:webapp /var/app/staging/storage/app/public
      
  06_post_deployment_fix:
    command: |
      # These commands run after deployment, when code is in current
      # This ensures the symlink is correctly set up in the final location
      rm -f /var/app/current/public/storage
      ln -sf /var/app/current/storage/app/public /var/app/current/public/storage
      chmod -R 775 /var/app/current/storage
      chown -R webapp:webapp /var/app/current/storage
    leader_only: true
      
  07_restart_httpd:
    command: "service httpd restart"